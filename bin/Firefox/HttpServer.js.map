{"version":3,"sources":["../../lib/Firefox/HttpServer.js"],"names":[],"mappings":"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","file":"HttpServer.js","sourcesContent":["\"use strict\";\r\nconst Constants = require('../Constants');\r\nconst HttpRequest = require('../HttpRequest');\r\n\r\nclass HttpServer {\r\n\tconstructor(tcpSocketProvider, urlProvider, httpResponder, httpRequestHandler, timer, fileResponder) {\r\n\t\tthis._tcpSocketProvider = tcpSocketProvider;\r\n\t\tthis._urlProvider = urlProvider;\r\n\t\tthis._httpResponder = httpResponder;\r\n\t\tthis._timer = timer;\r\n\t\tthis._fileResponder = fileResponder;\r\n\t\tthis._httpRequestHandler = httpRequestHandler;\r\n\r\n\t\tthis.isRunning = false;\r\n\t\tthis.port = null;\r\n\t\tthis.registeredPaths = {};\r\n\t\tthis.registeredFiles = {};\r\n\t}\r\n\r\n\tstart() {\r\n\t\tif (this.isRunning) return;\r\n\r\n\t\tif (!this.port) this.port = this._getRandomPort();\r\n\r\n\t\tthis._socket = this._tcpSocketProvider.create().listen(this.port, { binaryType: \"arraybuffer\" });\r\n\r\n\t\tthis._socket.onconnect(\r\n\t\t\t(incomingSocket) => {\r\n\t\t\t\tlet httpRequest = new HttpRequest();\r\n\t\t\t\tincomingSocket.ondata((data) =>\r\n\t\t\t\t\tthis._httpRequestHandler.handleRequest(incomingSocket, data, httpRequest,\r\n\t\t\t\t\t\t(request) => this._onRequestSuccess(request),\r\n\t\t\t\t\t\t(request, error) => this._onRequestError(request, error)));\r\n\t\t\t});\r\n\r\n\t\tthis.isRunning = true;\r\n\r\n\t\treturn this.port;\r\n\t}\r\n\tstop() {\r\n\t\tif (!this.isRunning) return;\r\n\t\tthis._socket.close();\r\n\t\tthis.isRunning = false;\r\n\t}\r\n\t_getRandomPort() {\r\n\t\treturn Math.floor(Math.random() * (65535 - 10000)) + 10000;\r\n\t}\r\n\t_onRequestSuccess(request) {\r\n\t\t/*todo: look into whether or not the below is actually a good idea */\r\n\t\tlet timeout = this._timer.setTimeout(() => {\r\n\t\t\t/* if (request.socket.isOpen())\r\n\t\t\t * this._httpResponder.sendTimeoutResponse(request.socket);\r\n\t\t\t */\r\n\t\t}, Constants.serverTimeoutInMilliseconds);\r\n\r\n\t\trequest.path = request.path.toLowerCase();\r\n\r\n\t\trequest.socket.onclose = () => this._timer.clearTimeout(timeout);\r\n\t\tif (this.registeredPaths.hasOwnProperty(request.path)) {\r\n\t\t\tthis.registeredPaths[request.path](request);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (this.registeredFiles.hasOwnProperty(request.path)) {\r\n\t\t\tthis._fileResponder.sendResponse(request, this.registeredFiles[request.path]);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis._httpResponder.sendFileNotFoundResponse(request.socket);\r\n\t}\r\n\t_onRequestError(request, err) {\r\n\t\tif (request.socket.isOpen())\r\n\t\t\tthis._httpResponder.sendErrorResponse(request.socket);\r\n\t\tconsole.warn('bad request received');\r\n\t}\r\n}\r\nmodule.exports = HttpServer;"]}