{"version":3,"sources":["../lib/FileResponder.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;;;;;;;IAEP,aAAa;AACJ,UADT,aAAa,CACH,SAAS,EAAE,aAAa,EAAE,eAAe,EAAE,YAAY,EAAE,eAAe,EAAE,GAAG,EAAE;wBADzF,aAAa;;AAEX,MAAI,CAAC,cAAc,GAAG,aAAa,CAAC;AACpC,MAAI,CAAC,UAAU,GAAG,SAAS,CAAC;AAC5B,MAAI,CAAC,gBAAgB,GAAG,eAAe,CAAC;AACxC,MAAI,CAAC,aAAa,GAAG,YAAY,CAAC;AACxC,MAAI,CAAC,gBAAgB,GAAG,eAAe,CAAC;AACxC,MAAI,CAAC,IAAI,GAAG,GAAG,CAAC;EACb;;cARC,aAAa;;SAUH,sBAAC,OAAO,EAAE,QAAQ,EAAE;;;AAClC,OAAI,CAAC,UAAU,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,UAAC,IAAuB,EAAK;QAA1B,SAAS,GAAX,IAAuB,CAArB,SAAS;QAAE,QAAQ,GAArB,IAAuB,CAAV,QAAQ;;AAC9D,QAAI,SAAS,GAAG,KAAK,CAAC;;sCACH,MAAK,gBAAgB,CAAC,UAAU,CAAC,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;;;;QAAxE,KAAK;QAAE,GAAG;;AAEf,OAAG,GAAG,GAAG,IAAI,SAAS,CAAC,UAAU,CAAC;;AAElC,QAAI,SAAS,GAAG,SAAS,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;AACnD,QAAI,iBAAiB,GAAG,IAAI,UAAU,CAAC,SAAS,CAAC,CAAC;;AAElD,QAAI,eAAe,GAAG,MAAK,gBAAgB,CAAC,qBAAqB,CAAC,OAAO,CAAC,OAAO,EAAE,QAAQ,EAAE,SAAS,CAAC,UAAU,EAAE,MAAK,IAAI,CAAC,iBAAiB,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;AAC5J,QAAI,OAAO,CAAC,MAAM,CAAC,WAAW,EAAE,KAAK,MAAM,EAAE,iBAAiB,GAAG,IAAI,CAAC;AACtE,QAAI,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,KAAK,YAAY,EAAE,SAAS,GAAG,IAAI,CAAC;;AAErE,UAAK,aAAa,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,eAAe,CAAC,MAAM,EAAE,IAAI,CAAC,CACnE,IAAI,CAAC,YAAM;AACX,WAAK,aAAa,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,iBAAiB,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;KAC7E,CAAC,CAAC;IACJ,EACA,UAAC,GAAG,EAAK;AACR,WAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAClB,UAAK,cAAc,CAAC,iBAAiB,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;IACtD,CAAC,CAAC;GACD;;;QAjCC,aAAa;;;AAoCnB,MAAM,CAAC,OAAO,GAAG,aAAa,CAAC","file":"FileResponder.js","sourcesContent":["\"use strict\";\r\n\r\nclass FileResponder {\r\n    constructor(fileUtils, httpResponder, networkingUtils, socketSender, responseBuilder, md5) {\r\n        this._httpResponder = httpResponder;\r\n        this._fileUtils = fileUtils;\r\n        this._networkingUtils = networkingUtils;\r\n        this._socketSender = socketSender;\r\n\t\tthis._responseBuilder = responseBuilder;\r\n\t\tthis._md5 = md5;\r\n    }\r\n\r\n    sendResponse(request, filePath) {\r\n\t\tthis._fileUtils.readBytes(filePath).then(({ fileBytes, mimetype }) => {\r\n\t\t\tlet keepAlive = false;\r\n\t\t\tlet [start, end] = this._networkingUtils.parseRange(request.headers['range']);\r\n\r\n\t\t\tend = end || fileBytes.byteLength;\r\n\r\n\t\t\tlet newBuffer = fileBytes.buffer.slice(start, end);\r\n\t\t\tlet fileResponseBytes = new Uint8Array(newBuffer);\r\n\r\n\t\t\tlet responseHeaders = this._responseBuilder.createResponseHeaders(request.headers, mimetype, fileBytes.byteLength, this._md5(fileResponseBytes.toString()));\r\n\t\t\tif (request.method.toLowerCase() === 'head') fileResponseBytes = null;\r\n\t\t\tif (request.headers['connection'] === 'keep-alive') keepAlive = true;\r\n\r\n\t\t\tthis._socketSender.send(request.socket, responseHeaders.buffer, true)\r\n\t\t\t\t.then(() => {\r\n\t\t\t\t\tthis._socketSender.send(request.socket, fileResponseBytes.buffer, keepAlive);\r\n\t\t\t\t});\r\n\t\t},\r\n\t\t\t(err) => {\r\n\t\t\t\tconsole.warn(err);\r\n\t\t\t\tthis._httpResponder.sendErrorResponse(request.socket);\r\n\t\t\t});\r\n    }\r\n}\r\n\r\nmodule.exports = FileResponder;"]}